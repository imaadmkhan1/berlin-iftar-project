<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Berlin Ramadan Iftar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    input, select, textarea { font-family: inherit; }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[2000] px-6 py-3 rounded-lg shadow-lg text-white font-medium hidden transition-opacity duration-300"></div>

  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-gray-800">Admin Login</h1>
        <p class="text-gray-500 text-sm mt-1">Manage mosque data</p>
      </div>
      <input type="password" id="passwordInput" placeholder="Enter password" class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-4 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
      <button onclick="checkPassword()" class="w-full bg-emerald-600 text-white font-semibold py-3 rounded-xl hover:bg-emerald-700 transition">Login</button>
      <p id="loginError" class="text-red-500 text-sm mt-3 text-center hidden">Incorrect password</p>
    </div>
  </div>

  <div id="editorScreen" class="hidden">
    <header class="bg-emerald-700 text-white py-4 px-6 shadow-lg">
      <div class="max-w-4xl mx-auto flex justify-between items-center flex-wrap gap-3">
        <h1 class="text-xl font-bold">Edit Mosque Data</h1>
        <a href="https://docs.google.com/spreadsheets/d/1aU9nWRR-B4wSHsrIBFH_iSfz6zl28SnGVNUurYfM7i4" target="_blank" class="bg-white text-emerald-700 px-4 py-2 rounded-lg hover:bg-emerald-50 text-sm font-medium">üìä Open Sheet</a>
      </div>
    </header>

    <main class="max-w-2xl mx-auto p-6 space-y-6">
      <!-- Add New Mosque Form -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-bold text-gray-800 mb-4">‚ûï Add New Mosque</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Google Maps Link</label>
            <input type="text" id="googleMapsUrl" placeholder="Paste Google Maps link here..." 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
              oninput="extractFromUrl(this.value)">
          </div>

          <div id="extractedData" class="hidden bg-emerald-50 rounded-lg p-4">
            <p class="text-sm text-emerald-700 font-medium mb-2">‚úÖ Extracted from Google Maps:</p>
            <p class="text-sm text-gray-600" id="extractedInfo"></p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mosque Name</label>
              <input type="text" id="mosqueName" placeholder="e.g. Pak Muhammad Jamia Masjid"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Iftar Days</label>
              <input type="text" id="mosqueDays" placeholder="e.g. Daily, Mon-Fri"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Latitude</label>
              <input type="number" step="0.000001" id="mosqueLat" placeholder="52.52..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Longitude</label>
              <input type="number" step="0.000001" id="mosqueLng" placeholder="13.40..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cuisine</label>
              <input type="text" id="mosqueCuisine" placeholder="e.g. Pakistani, Arab, Turkish"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Food</label>
              <input type="text" id="mosqueFood" placeholder="e.g. Dates, Rice, Curry"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="addMosque()" id="addBtn" class="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              ‚ûï Add to Sheet
            </button>
            <button onclick="clearForm()" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Existing Mosques -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold text-gray-800">Current Mosques</h2>
          <button onclick="loadMosques()" class="text-emerald-600 hover:text-emerald-700 text-sm">üîÑ Refresh</button>
        </div>
        <div id="mosqueList" class="space-y-3"></div>
      </div>

      <!-- Setup Instructions -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-sm text-yellow-800">
        <p class="font-medium">‚ö†Ô∏è First time setup?</p>
        <p class="mt-1">If adding doesn't work, you need to deploy the Google Apps Script:</p>
        <ol class="mt-2 list-decimal list-inside space-y-1">
          <li>Open the file <code class="bg-yellow-100 px-1 rounded">Code.gs</code> in your repo</li>
          <li>Copy the code and paste into <a href="https://script.google.com" target="_blank" class="underline">script.google.com</a> ‚Üí New Project</li>
          <li>Deploy ‚Üí New Deployment ‚Üí Web App</li>
          <li>Set "Execute as" to "Me", "Who has access" to "Anyone"</li>
          <li>Copy the Web App URL and update <code class="bg-yellow-100 px-1 rounded">ADMIN_URL</code> in this file</li>
        </ol>
      </div>
    </main>
  </div>

  <script>
    // === CONFIGURATION ===
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpj8sE_TOdNRibQy6GC_38PnRpssweoqykUELUo4JyrvCni8K6iuZlp_FFvwyU3bfG26Hv7s8lQWgW/pub?output=csv';
    const ADMIN_URL = 'https://script.google.com/macros/s/AKfycbyuRcu-NEdn5lTS9e-d2iSk-rnmZLLMs90yFIqJyROxaM4SRljdopzu3g3dWK3pNw2QlA/exec';
    const PASSWORD = 'password';

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-[2000] px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-emerald-600'}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function extractFromUrl(url) {
      if (!url) {
        document.getElementById('extractedData').classList.add('hidden');
        return;
      }

      // Match coordinates from Google Maps URL
      const coordMatch = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
      const nameMatch = url.match(/place\/([^\/]+)/);
      
      if (coordMatch) {
        document.getElementById('mosqueLat').value = coordMatch[1];
        document.getElementById('mosqueLng').value = coordMatch[2];
        
        let name = '';
        if (nameMatch) {
          name = decodeURIComponent(nameMatch[1].replace(/\+/g, ' '));
          document.getElementById('mosqueName').value = name;
        }

        document.getElementById('extractedInfo').innerHTML = `
          <strong>${name || 'Name extracted'}</strong><br>
          üìç ${coordMatch[1]}, ${coordMatch[2]}
        `;
        document.getElementById('extractedData').classList.remove('hidden');
      }
    }

    async function addMosque() {
      const name = document.getElementById('mosqueName').value.trim();
      const lat = parseFloat(document.getElementById('mosqueLat').value);
      const lng = parseFloat(document.getElementById('mosqueLng').value);
      const days = document.getElementById('mosqueDays').value.trim() || 'Daily';
      const cuisine = document.getElementById('mosqueCuisine').value.trim();
      const food = document.getElementById('mosqueFood').value.trim();
      const googleMapsUrl = document.getElementById('googleMapsUrl').value.trim();

      if (!name || !lat || !lng) {
        showToast('Please fill in name and coordinates', true);
        return;
      }

      const btn = document.getElementById('addBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Adding...';

      try {
        if (ADMIN_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
          showToast('Please deploy Google Apps Script first - see instructions below', true);
          return;
        }

        showToast('Connecting...', false);

        const response = await fetch(ADMIN_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify({
            action: 'add',
            name, lat, lng, days, cuisine, food, googleMapsUrl
          })
        });

        // With no-cors, we can't read the response, but the request goes through
        showToast('‚úÖ Mosque added! (refresh the page to see it)');
        clearForm();
        loadMosques();
        
      } catch (e) {
        console.error('Error:', e);
        showToast('‚ùå Error: ' + e.message, true);
      }

      btn.disabled = false;
      btn.textContent = '‚ûï Add to Sheet';
    }

    async function deleteMosque(name) {
      if (!confirm(`Delete "${name}"?`)) return;

      try {
        if (ADMIN_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
          showToast('Please deploy Google Apps Script first', true);
          return;
        }

        const response = await fetch(ADMIN_URL, {
          method: 'POST',
          redirect: 'follow',
          body: JSON.stringify({ action: 'delete', name })
        });

        const text = await response.text();
        
        if (text.includes('success')) {
          showToast('‚úÖ Deleted successfully!');
          loadMosques();
        } else {
          showToast('‚úÖ Deleted! (refresh to confirm)', false);
          loadMosques();
        }
      } catch (e) {
        console.error(e);
        showToast('‚ùå Could not connect', true);
      }
    }

    async function loadMosques() {
      const container = document.getElementById('mosqueList');
      container.innerHTML = '<p class="text-gray-500 text-center py-4">Loading...</p>';
      
      try {
        const response = await fetch(CSV_URL + '&t=' + Date.now());
        const text = await response.text();
        const lines = text.trim().split('\n');
        
        if (lines.length <= 1) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">No mosques found</p>';
          return;
        }
        
        container.innerHTML = '';
        
        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i]);
          if (values.length >= 4 && values[0]) {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
              <div>
                <p class="font-medium text-gray-800">${values[0]}</p>
                <p class="text-sm text-gray-500">${values[3] || ''} ‚Ä¢ ${values[4] || ''}</p>
              </div>
              <button onclick="deleteMosque('${values[0].replace(/'/g, "\\'")}')" class="text-red-500 hover:text-red-700 text-sm px-3 py-1">
                üóëÔ∏è Delete
              </button>
            `;
            container.appendChild(div);
          }
        }
      } catch (e) {
        console.error(e);
        container.innerHTML = '<p class="text-red-500 text-center py-4">Error loading mosques</p>';
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
        else { current += char; }
      }
      result.push(current.trim());
      return result;
    }

    function clearForm() {
      document.getElementById('googleMapsUrl').value = '';
      document.getElementById('mosqueName').value = '';
      document.getElementById('mosqueDays').value = '';
      document.getElementById('mosqueLat').value = '';
      document.getElementById('mosqueLng').value = '';
      document.getElementById('mosqueCuisine').value = '';
      document.getElementById('mosqueFood').value = '';
      document.getElementById('extractedData').classList.add('hidden');
    }

    function checkPassword() {
      const input = document.getElementById('passwordInput').value;
      if (input === PASSWORD) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('editorScreen').classList.remove('hidden');
        loadMosques();
      } else {
        document.getElementById('loginError').classList.remove('hidden');
      }
    }

    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') checkPassword();
    });
  </script>
</body>
</html>
