<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Berlin Iftar Project | Find Iftar Locations in Berlin</title>
  <meta name="description" content="Discover iftar spots across Berlin during Ramadan. Community-contributed map showing mosques offering free iftar meals. Filter by day, cuisine, and location.">
  <meta name="keywords" content="Ramadan iftar Berlin, mosque iftar Berlin, free iftar Berlin, Ramadan 2026 Berlin, fast breaking spots Berlin, Islamic community Berlin">
  <meta name="author" content="Imaad Mohamed Khan">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Berlin Iftar Project | Find Iftar Locations in Berlin">
  <meta property="og:description" content="Discover iftar spots across Berlin during Ramadan. Community-contributed map showing mosques offering free iftar meals.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://imaadkhan.com/berlin-ramadan-iftar/">
  <meta property="og:image" content="https://imaadkhan.com/berlin-ramadan-iftar/og-image.png">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Berlin Iftar Project | Find Iftar Locations">
  <meta name="twitter:description" content="Discover iftar spots across Berlin during Ramadan. Community-contributed map showing mosques offering free iftar meals.">
  
  <!-- Schema.org structured data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Berlin Iftar Project",
    "description": "Interactive map helping Berlin residents find iftar locations during Ramadan. Community-contributed data showing mosques that offer free iftar meals.",
    "url": "https://imaadkhan.com/berlin-ramadan-iftar/",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "EUR"
    },
    "creator": {
      "@type": "Person",
      "name": "Imaad Mohamed Khan"
    }
  }
  </script>
  
  <link rel="canonical" href="https://imaadkhan.com/berlin-ramadan-iftar/">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.counter.dev/script.js" data-id="7c5e6e25-ea32-46ec-bdd0-460f73d21f7e" data-utcoffset="1"></script>
  <style>
    .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; }
    .leaflet-popup-content { margin: 12px 14px; line-height: 1.6; }
    .leaflet-popup-close-button { font-size: 24px !important; width: 36px !important; height: 36px !important; padding: 6px !important; }
    .leaflet-popup-content a { padding: 8px 12px; display: inline-block; margin-top: 4px; background: #ecfdf5; border-radius: 6px; text-decoration: none; }
    @media (pointer: coarse) { .leaflet-popup-close-button { width: 44px !important; height: 44px !important; } }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="bg-emerald-700 text-white py-4 px-6 shadow-lg">
    <div class="max-w-4xl mx-auto flex justify-between items-center flex-wrap gap-2">
      <div>
        <h1 class="text-xl md:text-2xl font-bold">Berlin Iftar Project</h1>
        <p class="text-sm text-emerald-100" data-i18n="tagline">Find iftar at a mosque near you</p>
      </div>
      <div class="flex items-center gap-4">
        <p class="text-sm text-emerald-100"><span data-i18n="lastUpdated">Data Last Updated</span>: <span id="lastUpdated">Loading...</span></p>
        <div class="flex items-center gap-2">
          <span class="text-sm text-emerald-100" data-i18n="language">Language:</span>
          <button onclick="toggleLanguage()" id="langToggle" class="text-sm bg-emerald-800 hover:bg-emerald-900 px-2 py-1 rounded">English</button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 relative">
    <div id="map" class="h-[calc(100vh-160px)] md:h-[calc(100vh-80px)]"></div>
    <div class="absolute top-4 left-4 right-4 md:left-auto md:right-4 md:w-64 z-[1000] bg-white rounded-lg shadow-lg p-3 space-y-3">
      <button onclick="toggleFilters()" class="md:hidden w-full px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium flex justify-between items-center">
        <span data-i18n="filters">Filters</span>
        <span id="filterToggleIcon">‚ñº</span>
      </button>
      <div id="filterContent" class="space-y-3 hidden md:block">
        <button onclick="resetFilters()" class="w-full px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors" data-i18n="deselectAll">
          Deselect All
        </button>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="iAmIn">I am in</label>
        <select id="bezirkSelect" onchange="zoomToBezirk(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none text-sm">
          <option value="" data-i18n="selectArea">Select area...</option>
          <option value="52.50,13.45">Friedrichshain-Kreuzberg</option>
          <option value="52.52,13.48">Lichtenberg</option>
          <option value="52.54,13.20">Spandau</option>
          <option value="52.53,13.38">Mitte</option>
          <option value="52.48,13.43">Neuk√∂lln</option>
          <option value="52.57,13.40">Pankow</option>
          <option value="52.43,13.25">Steglitz-Zehlendorf</option>
          <option value="52.59,13.33">Reinickendorf</option>
          <option value="52.48,13.35">Tempelhof-Sch√∂neberg</option>
          <option value="52.52,13.37">Tiergarten</option>
          <option value="52.55,13.35">Wedding</option>
          <option value="52.514,13.29">Charlottenburg</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="selectMosque">Select Mosque</label>
        <select id="mosqueSelect" onchange="zoomToMosque(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none text-sm">
          <option value="" data-i18n="allMosques">All mosques...</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="day">Day</label>
        <select id="dayFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none text-sm">
          <option value="" data-i18n="allDays">All days</option>
          <option value="Daily">Daily</option>
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
          <option value="Saturday">Saturday</option>
          <option value="Sunday">Sunday</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="cuisine">Cuisine</label>
        <select id="cuisineFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none text-sm">
          <option value="" data-i18n="allCuisines">All cuisines</option>
        </select>
      </div>
      <div id="resultCount" class="text-sm text-gray-600 font-medium text-center py-1"></div>
      </div>
    </div>
  </main>

  <footer class="bg-gray-800 text-gray-300 py-3 px-4 fixed bottom-0 w-full z-[1001]">
    <div class="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center text-xs md:text-sm flex-wrap gap-2 text-center">
      <p data-i18n="tapPin">Tap a pin to see iftar details</p>
      <button onclick="showDisclaimer()" class="text-emerald-400 hover:text-emerald-300 underline cursor-pointer" data-i18n="disclaimer">‚ö†Ô∏è Disclaimer</button>
      <a href="https://forms.gle/kzLKXBWPFdQGiAwWA" target="_blank" class="text-emerald-400 hover:text-emerald-300 underline" data-i18n="contribute">Contribute a location</a>
      <p data-i18n="madeWith">Made with ‚ù§Ô∏è in Berlin by <a href="https://in.linkedin.com/in/imaad-mohamed-khan-218b3999" target="_blank" class="text-emerald-400 hover:text-emerald-300">Imaad Mohamed Khan</a> and AI ü§ñ</p>
    </div>
  </footer>

  <div id="disclaimerModal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-5">
      <div class="flex justify-between items-start mb-3">
        <h3 class="text-lg font-bold text-gray-800" data-i18n="disclaimerTitle">Disclaimer</h3>
        <button onclick="hideDisclaimer()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>
      <p class="text-sm text-gray-600 leading-relaxed" data-i18n="disclaimerText">
        Information provided based on crowd sourced data. We do not guarantee the availability of iftar in any mosque. Please make your own decision or contact the mosque administration before deciding to be there for iftar.
      </p>
      <button onclick="hideDisclaimer()" class="mt-4 w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-medium" data-i18n="iUnderstand">I Understand</button>
    </div>
  </div>

  <script>
    const translations = {
      en: {
        language: "Language:",
        tagline: "Find iftar at a mosque near you",
        lastUpdated: "Data Last Updated",
        filters: "Filters",
        deselectAll: "Deselect All",
        iAmIn: "I am in",
        selectArea: "Select area...",
        selectMosque: "Select Mosque",
        allMosques: "All mosques...",
        day: "Day",
        allDays: "All days",
        cuisine: "Cuisine",
        allCuisines: "All cuisines",
        tapPin: "Tap a pin to see iftar details",
        disclaimer: "‚ö†Ô∏è Disclaimer",
        contribute: "Contribute a location",
        madeWith: "Made with ‚ù§Ô∏è in Berlin by <a href=\"https://in.linkedin.com/in/imaad-mohamed-khan-218b3999\" target=\"_blank\" class=\"text-emerald-400 hover:text-emerald-300\">Imaad Mohamed Khan</a> and AI ü§ñ",
        disclaimerTitle: "Disclaimer",
        disclaimerText: "Information provided based on crowd sourced data. We do not guarantee the availability of iftar in any mosque. Please make your own decision or contact the mosque administration before deciding to be there for iftar.",
        iUnderstand: "I Understand",
        openInMaps: "Open in Maps",
        iftarDays: "Iftar Days",
        typicalFood: "Typical Food",
        mosqueFound: "mosque found",
        mosquesFound: "mosques found"
      },
      de: {
        language: "Sprache:",
        tagline: "Finde Iftar in einer Moschee in deiner N√§he",
        lastUpdated: "Daten zuletzt aktualisiert",
        filters: "Filter",
        deselectAll: "Auswahl aufheben",
        iAmIn: "Ich bin in",
        selectArea: "Bereich ausw√§hlen...",
        selectMosque: "Moschee ausw√§hlen",
        allMosques: "Alle Moscheen...",
        day: "Tag",
        allDays: "Alle Tage",
        cuisine: "K√ºche",
        allCuisines: "Alle K√ºchen",
        tapPin: "Tippe auf einen Pin f√ºr Iftar-Details",
        disclaimer: "‚ö†Ô∏è Haftungsausschluss",
        contribute: "Ort hinzuf√ºgen",
        madeWith: "Mit ‚ù§Ô∏è in Berlin gemacht von <a href=\"https://in.linkedin.com/in/imaad-mohamed-khan-218b3999\" target=\"_blank\" class=\"text-emerald-400 hover:text-emerald-300\">Imaad Mohamed Khan</a> und KI ü§ñ",
        disclaimerTitle: "Haftungsausschluss",
        disclaimerText: "Die Informationen basieren auf crowdsourced Daten. Wir garantieren nicht die Verf√ºgbarkeit von Iftar in irgendeiner Moschee. Bitte treffen Sie Ihre eigene Entscheidung oder kontaktieren Sie die Moschee-Verwaltung, bevor Sie sich f√ºr Iftar dort aufhalten.",
        iUnderstand: "Ich verstehe",
        openInMaps: "In Maps √∂ffnen",
        iftarDays: "Iftar-Tage",
        typicalFood: "Typisches Essen",
        mosqueFound: "Moschee gefunden",
        mosquesFound: "Moscheen gefunden"
      }
    };

    let currentLang = localStorage.getItem('lang') || 'en';

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      document.getElementById('langToggle').textContent = lang === 'en' ? 'English' : 'Deutsch';
      
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
          if (key === 'madeWith') {
            el.innerHTML = translations[lang][key];
          } else {
            el.textContent = translations[lang][key];
          }
        }
      });
      
      updateResultCount();
    }

    function toggleLanguage() {
      setLanguage(currentLang === 'en' ? 'de' : 'en');
    }

    function showDisclaimer() {
      document.getElementById('disclaimerModal').classList.remove('hidden');
    }
    function hideDisclaimer() {
      document.getElementById('disclaimerModal').classList.add('hidden');
      localStorage.setItem('disclaimerShown', 'true');
    }

    // Show disclaimer on first visit
    if (!localStorage.getItem('disclaimerShown')) {
      setTimeout(showDisclaimer, 500);
    }

    function toggleFilters() {
      const content = document.getElementById('filterContent');
      const icon = document.getElementById('filterToggleIcon');
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '‚ñº';
      } else {
        content.classList.add('hidden');
        icon.textContent = '‚ñ∂';
      }
    }
  </script>

  <script>
    // === CONFIGURATION ===
    // Replace with your Google Sheet published CSV URL
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpj8sE_TOdNRibQy6GC_38PnRpssweoqykUELUo4JyrvCni8K6iuZlp_FFvwyU3bfG26Hv7s8lQWgW/pub?output=csv';

    const map = L.map('map').setView([52.52, 13.405], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const mosqueIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div class="w-10 h-10 md:w-8 md:h-8 bg-emerald-600 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 md:w-5 md:h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });

    let allMosques = [];
    const markerGroup = L.layerGroup().addTo(map);

    function updateResultCount(count) {
      const text = count === 1 ? translations[currentLang].mosqueFound : translations[currentLang].mosquesFound;
      document.getElementById('resultCount').textContent = count === 1 ? `1 ${text}` : `${count} ${text}`;
    }

    function createPopupContent(mosque) {
      const mapsLink = mosque.googleMapsUrl ? 
        `<p><span class="font-semibold">üìç Google Maps:</span> <a href="${mosque.googleMapsUrl}" target="_blank" class="text-emerald-600 underline hover:text-emerald-800">${translations[currentLang].openInMaps}</a></p>` : '';

      return `
        <div class="p-3 min-w-[220px] md:min-w-[200px]">
          <h3 class="font-bold text-lg text-emerald-800 mb-2">${mosque.name}</h3>
          <div class="space-y-2 text-sm md:text-base">
            <p><span class="font-semibold">üìÖ ${translations[currentLang].iftarDays}:</span> ${mosque.days}</p>
            <p><span class="font-semibold">üçΩÔ∏è ${translations[currentLang].cuisine}:</span> ${mosque.cuisine}</p>
            <p><span class="font-semibold">üç≤ ${translations[currentLang].typicalFood}:</span> ${mosque.food}</p>
            ${mapsLink}
          </div>
        </div>
      `;
    }

    function zoomToMosque(value) {
      if (!value) return;
      const [lat, lng] = value.split(',').map(Number);
      map.setView([lat, lng], 16);
      
      // Auto-filter dropdowns to match selected mosque
      const selectedMosque = allMosques.find(m => `${m.lat},${m.lng}` === value);
      if (selectedMosque) {
        document.getElementById('dayFilter').value = selectedMosque.days;
        document.getElementById('cuisineFilter').value = selectedMosque.cuisine;
      }
      
      applyFilters();
    }

    const AREA_BOUNDS = {
      '52.50,13.28': { lat: 52.50, lng: 13.28, radius: 0.03 },
      '52.50,13.45': { lat: 52.50, lng: 13.45, radius: 0.03 },
      '52.52,13.48': { lat: 52.52, lng: 13.48, radius: 0.03 },
      '52.54,13.20': { lat: 52.54, lng: 13.20, radius: 0.03 },
      '52.53,13.38': { lat: 52.53, lng: 13.38, radius: 0.03 },
      '52.48,13.43': { lat: 52.48, lng: 13.43, radius: 0.03 },
      '52.57,13.40': { lat: 52.57, lng: 13.40, radius: 0.03 },
      '52.43,13.25': { lat: 52.43, lng: 13.25, radius: 0.03 },
      '52.59,13.33': { lat: 52.59, lng: 13.33, radius: 0.03 },
      '52.48,13.35': { lat: 52.48, lng: 13.35, radius: 0.03 },
      '52.52,13.37': { lat: 52.52, lng: 13.37, radius: 0.03 },
      '52.52,13.31': { lat: 52.52, lng: 13.31, radius: 0.03 }
    };

    function isInArea(lat, lng, areaKey) {
      const area = AREA_BOUNDS[areaKey];
      if (!area) return true;
      const distance = Math.sqrt(Math.pow(lat - area.lat, 2) + Math.pow(lng - area.lng, 2));
      return distance <= area.radius;
    }

    function applyFilters() {
      if (!allMosques || allMosques.length === 0) return;
      
      const dayFilter = document.getElementById('dayFilter').value;
      const cuisineFilter = document.getElementById('cuisineFilter').value;
      const mosqueSelect = document.getElementById('mosqueSelect');
      const selectedMosque = mosqueSelect.value;
      const bezirkSelect = document.getElementById('bezirkSelect');
      const areaFilter = bezirkSelect.value;

      const filtered = allMosques.filter(mosque => {
        const dayMatch = !dayFilter || 
          mosque.days.toLowerCase().includes(dayFilter.toLowerCase()) || 
          mosque.days.toLowerCase() === 'daily';
        const cuisineMatch = !cuisineFilter || mosque.cuisine === cuisineFilter;
        const mosqueMatch = !selectedMosque || `${mosque.lat},${mosque.lng}` === selectedMosque;
        const areaMatch = !areaFilter || isInArea(mosque.lat, mosque.lng, areaFilter);
        return dayMatch && cuisineMatch && mosqueMatch && areaMatch;
      });

      markerGroup.clearLayers();
      filtered.forEach(mosque => {
        L.marker([mosque.lat, mosque.lng], { icon: mosqueIcon })
          .addTo(markerGroup)
          .bindPopup(createPopupContent(mosque));
      });

      updateResultCount(filtered.length);

      // Only cascade dropdowns if no specific mosque is selected
      if (!selectedMosque) {
        updateDropdownOptions(filtered);
      } else {
        // Even when mosque is selected, update cuisines dropdown for consistency
        const cuisines = [...new Set(allMosques.map(m => m.cuisine).filter(c => c))].sort();
        const cuisineSelect = document.getElementById('cuisineFilter');
        const currentCuisineValue = cuisineSelect.value;
        cuisineSelect.innerHTML = `<option value="">${translations[currentLang].allCuisines}</option>`;
        cuisines.forEach(cuisine => {
          const option = document.createElement('option');
          option.value = cuisine;
          option.textContent = cuisine;
          cuisineSelect.appendChild(option);
        });
        if (currentCuisineValue && cuisines.includes(currentCuisineValue)) {
          cuisineSelect.value = currentCuisineValue;
        }
      }
      updateURLParams();
    }

    function updateDropdownOptions(filteredMosques) {
      const mosqueSelect = document.getElementById('mosqueSelect');
      const cuisineSelect = document.getElementById('cuisineFilter');
      const daySelect = document.getElementById('dayFilter');
      const currentMosqueValue = mosqueSelect.value;
      const currentCuisineValue = cuisineSelect.value;
      const currentDayValue = daySelect.value;

      mosqueSelect.innerHTML = `<option value="">${translations[currentLang].allMosques}</option>`;
      filteredMosques
        .slice()
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(mosque => {
          const option = document.createElement('option');
          option.value = `${mosque.lat},${mosque.lng}`;
          option.textContent = mosque.name;
          mosqueSelect.appendChild(option);
        });

      const cuisines = [...new Set(filteredMosques.map(m => m.cuisine).filter(c => c))].sort();
      cuisineSelect.innerHTML = `<option value="">${translations[currentLang].allCuisines}</option>`;
      cuisines.forEach(cuisine => {
        const option = document.createElement('option');
        option.value = cuisine;
        option.textContent = cuisine;
        cuisineSelect.appendChild(option);
      });

      if (currentMosqueValue) {
        const hasValue = filteredMosques.some(m => `${m.lat},${m.lng}` === currentMosqueValue);
        mosqueSelect.value = hasValue ? currentMosqueValue : '';
      }
      if (currentCuisineValue) {
        const hasValue = cuisines.includes(currentCuisineValue);
        cuisineSelect.value = hasValue ? currentCuisineValue : '';
      }
    }

    function resetFilters() {
      document.getElementById('bezirkSelect').value = '';
      document.getElementById('mosqueSelect').value = '';
      document.getElementById('dayFilter').value = '';
      document.getElementById('cuisineFilter').value = '';
      
      map.setView([52.52, 13.405], 12);
      
      markerGroup.clearLayers();
      allMosques.forEach(mosque => {
        L.marker([mosque.lat, mosque.lng], { icon: mosqueIcon })
          .addTo(markerGroup)
          .bindPopup(createPopupContent(mosque));
      });

      updateResultCount(allMosques.length);

      updateDropdownOptions(allMosques);
      updateURLParams();
    }

    function zoomToBezirk(value) {
      if (!value) {
        applyFilters();
        return;
      }
      const [lat, lng] = value.split(',').map(Number);
      map.setView([lat, lng], 14);
      applyFilters();
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
        else { current += char; }
      }
      result.push(current.trim());
      return result;
    }

    async function loadMosqueData() {
      if (CSV_URL === 'YOUR_GOOGLE_SHEET_CSV_URL_HERE') {
        document.getElementById('lastUpdated').textContent = 'Setup needed';
        return;
      }

      try {
        const response = await fetch(CSV_URL + '&t=' + Date.now());
        const text = await response.text();
        const lines = text.trim().split('\n');

        allMosques = [];
        let latestDate = null;

        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i]);
          if (values.length >= 8 && values[7]) {
            const dateStr = values[7].trim();
            const parts = dateStr.split(/[\/\-]/);
            let rowDate;
            if (parts.length === 3) {
              rowDate = new Date(parts[2], parts[1] - 1, parts[0]);
            } else {
              rowDate = new Date(dateStr);
            }
            if (!isNaN(rowDate) && (!latestDate || rowDate > latestDate)) {
              latestDate = rowDate;
            }
          }
          if (values.length >= 7 && values[1] && values[2]) {
            const mosque = {
              name: values[0] || '',
              lat: parseFloat(values[1]) || 0,
              lng: parseFloat(values[2]) || 0,
              days: values[3] || '',
              cuisine: values[4] || '',
              food: values[5] || '',
              googleMapsUrl: values[6] || ''
            };
            allMosques.push(mosque);
          }
        }

        document.getElementById('lastUpdated').textContent = latestDate && !isNaN(latestDate) 
          ? latestDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
          : new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

        updateDropdownOptions(allMosques);
        
        // Show all markers by default
        markerGroup.clearLayers();
        allMosques.forEach(mosque => {
          L.marker([mosque.lat, mosque.lng], { icon: mosqueIcon })
            .addTo(markerGroup)
            .bindPopup(createPopupContent(mosque));
        });
        updateResultCount(allMosques.length);
        
        // Then check URL params and apply filters if present
        loadURLParams();
      } catch (e) {
        console.error('Error loading data:', e);
        document.getElementById('lastUpdated').textContent = 'Error loading data';
      }
    }

    function updateURLParams() {
      const params = new URLSearchParams();
      const day = document.getElementById('dayFilter').value;
      const cuisine = document.getElementById('cuisineFilter').value;
      const area = document.getElementById('bezirkSelect').value;
      
      if (day) params.set('day', day);
      if (cuisine) params.set('cuisine', cuisine);
      if (area) params.set('area', area);
      
      const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.replaceState({}, '', newURL);
    }

    function loadURLParams() {
      const params = new URLSearchParams(window.location.search);
      let hasFilters = false;
      
      if (params.has('day')) {
        document.getElementById('dayFilter').value = params.get('day');
        hasFilters = true;
      }
      if (params.has('cuisine')) {
        document.getElementById('cuisineFilter').value = params.get('cuisine');
        hasFilters = true;
      }
      if (params.has('area')) {
        document.getElementById('bezirkSelect').value = params.get('area');
        hasFilters = true;
      }
      
      if (hasFilters && allMosques.length > 0) {
        applyFilters();
      }
    }

    loadMosqueData();
    setLanguage(currentLang);
  </script>
</body>
</html>
